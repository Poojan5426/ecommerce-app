name: Secure CD - Production Deployment

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Terraform Deployment"]
    types:
      - completed

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Download build artifact from CI
      - name: Download build artifact from CI
        uses: actions/download-artifact@v3
        with:
          name: ecommerce-artifact
          path: ./artifact

      # 3. Verify artifact integrity locally (CD side)
      - name: Verify checksum (CD side)
        run: |
          cd artifact
          EXPECTED_HASH=$(awk '{print $1}' checksum.txt)
          ACTUAL_HASH=$(sha256sum *.jar | awk '{print $1}')

          if [ "$EXPECTED_HASH" != "$ACTUAL_HASH" ]; then
            echo "Artifact integrity check FAILED"
            exit 1
          fi

          echo "Artifact integrity verified"

      # 4. Fetch EC2 Host and SSH Key from Vault
      - name: Fetch EC2 secrets from Vault
        id: vault
        uses: hashicorp/vault-action@v3
        with:
          url: http://PUBLIC_IP_OF_VAULT:PORT_NUMBER
          role: gh-actions-role
          method: jwt
          secrets: |
            ec2/deploy host | EC2_HOST
            ec2/deploy private_key | EC2_SSH_KEY

      # 5. Copy artifact to EC2
      - name: Copy artifact to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ steps.vault.outputs.EC2_HOST }}
          username: ec2-user
          key: ${{ steps.vault.outputs.EC2_SSH_KEY }}
          source: "artifact/*"
          target: "/opt/app/"

      # 6. Deploy application on EC2
      - name: Deploy application
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ steps.vault.outputs.EC2_HOST }}
          username: ec2-user
          key: ${{ steps.vault.outputs.EC2_SSH_KEY }}
          script: |
            cd /opt/app
            EXPECTED_HASH=$(awk '{print $1}' checksum.txt)
            ACTUAL_HASH=$(sha256sum *.jar | awk '{print $1}')

            if [ "$EXPECTED_HASH" != "$ACTUAL_HASH" ]; then
              echo "EC2 integrity check FAILED"
              exit 1
            fi

            sudo systemctl stop ecommerce-app || true
            sudo cp *.jar /opt/ecommerce/ecommerce.jar
            sudo systemctl start ecommerce-app

      # 7. Smoke test
      - name: Smoke Test
        run: |
          sleep 20
          curl -f http://${{ steps.vault.outputs.EC2_HOST }}:8080/actuator/health

      # 8. Rollback on failure
      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ steps.vault.outputs.EC2_HOST }}
          username: ec2-user
          key: ${{ steps.vault.outputs.EC2_SSH_KEY }}
          script: |
            sudo systemctl stop ecommerce-app
            sudo systemctl start ecommerce-app-previous
